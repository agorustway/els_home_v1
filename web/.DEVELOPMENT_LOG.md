# Development Log

## [2026-01-24] - 소셜 로그인 프로필 연동 디버깅 및 정책 가이드

### 🚀 핵심 성과
- **디버깅 로그 강화**: 카카오 및 네이버 로그인 시 전달되는 `user_metadata`를 서버 로그에서 확인할 수 있도록 `route.js`에 로깅 로직을 추가했습니다.
- **동의 항목 정책 가이드**: 카카오 개발자 센터의 동의 항목을 '선택'에서 '필수'로 변경하도록 안내하여 데이터 누락 가능성을 원천 차단했습니다.

---

## [2026-01-24] - 카카오 프로필 연동 이슈 집중 해결

### 🚀 핵심 성과
- **소셜 프로필 추출 로직 전면 개편**: 카카오톡 로그인 시 이름과 프로필 사진이 누락되는 문제를 해결하기 위해 `user_metadata` 내의 모든 가능성 있는 키값(`nickname`, `profile_image`, `preferred_username` 등)을 전수 조사하여 매핑하도록 `route.js`를 수정했습니다.
- **안정성 강화**: 메타데이터 접근 시 옵셔널 체이닝을 적용하여 데이터 누락 시에도 런타임 에러가 발생하지 않도록 방어 코드를 작성했습니다.

---

## [2026-01-24] - 시스템 안정화 및 무한 루프 트러블슈팅 (TDD 기반)

### 🚀 핵심 성과
- **모바일 리다이렉트 루프 해결**: 방문자 권한으로 보호된 페이지 접근 시 `/login`이 아닌 `/employees`로 리다이렉트하여 무한 반복 현상을 수정했습니다.
- **프로필 매핑 로직 전수 동기화**: 네이버/카카오/구글의 사용자 정보 매핑 로직을 동일하게 강화하여 프로필 정보 연동 문제를 해결했습니다.
- **Next.js 14 호환성 확보**: Client Component에서 `useParams`를 사용하여 지점 페이지 로딩 오류를 해결했습니다.
- **지점 명칭 통일**: 모든 UI에서 '아산지점'으로 명칭을 통일했습니다.

---

## [2026-01-24] - 시스템 안정화 및 무한 루프 트러블슈팅

### 🚀 핵심 성과
- **모바일 리다이렉트 루프 해결**: 방문자 권한으로 보호된 페이지 접근 시 `/login`이 아닌 `/employees`로 리다이렉트하여, 이미 인증된 사용자가 로그인 페이지와 보호 페이지 사이를 무한 반복하는 현상을 수정했습니다.
- **프로필 매핑 로직 전수 동기화**: 네이버 OIDC와 표준 OAuth 콜백의 사용자 정보 매핑 로직을 동일하게 강화하여 소셜 서비스 종류에 관계없이 이름과 사진이 정상 연동되도록 개선했습니다.
- **지점 명칭 통일**: '아산지점 (CY)' 표기를 모든 컴포넌트와 데이터 파일에서 '아산지점'으로 통일했습니다.

---

## [2026-01-24] - 빌드 안정화 및 소셜 프로필 매핑 최적화

### 🚀 핵심 성과
- **Next.js 버전 호환성 확보**: Next.js 14 환경에 맞춰 `BranchPage`의 `params` 접근 로직을 안정화하여 페이지 로딩 오류를 해결했습니다.
- **카카오/네이버 프로필 매핑 강화**: 소셜 제공자별로 상이한 메타데이터 키값(`nickname`, `profile_image`, `picture` 등)을 모두 대응하도록 `route.js`를 보강했습니다.
- **빌드 에러 진단**: `error.txt` 분석을 통해 `services`, `dashboard`, `network` 페이지의 컴포넌트 경로 참조 오류를 확인하고 가이드를 수립했습니다.

---

## [2026-01-24] - 시스템 안정화 및 보안 정책 정밀 교정

### 🚀 핵심 성과
- **모바일 무한 루프 해결**: 미들웨어의 세션 체크 및 리다이렉트 로직을 최적화하여 모바일 환경에서의 반복 로그인 현상을 제거했습니다.
- **방문자 보안 강화**: 'visitor' 권한 사용자가 임직원 전용 게시판 및 자료실에 접근할 수 없도록 미들웨어 레벨에서 차단 로직을 복구했습니다.
- **카카오 프로필 연동 완결**: 카카오 메타데이터의 다양한 키값(`nickname`, `picture` 등)을 모두 대응하여 프로필 정보 누락 문제를 해결했습니다.
- **명칭 및 오류 수정**: '아산지점' 명칭을 통일하고, 클라이언트 컴포넌트의 `params` 접근 오류를 수정했습니다.

### 🛠️ 작업 상세
#### 1. 보안 및 인증
- `middleware.js`: `/employees` 하위 경로에 대한 'visitor' 접근 차단 로직 추가.
- `app/auth/callback/route.js`: 카카오 사용자 정보 매핑 로직 강화.
#### 2. UI/UX 및 버그 수정
- `app/employees/branches/[branch]/page.js`: `React.use(params)` 적용으로 페이지 로딩 오류 수정 및 지점명칭 교정.
- `constants/locations.js` & `Header.js`: '아산지점 (CY)'을 '아산지점'으로 명칭 통일.
- **브라우저 아이콘(Favicon) 최적화**: 모든 환경(Shortcut, Apple Icon)에서 로고가 정상 표시되도록 설정을 보강했습니다.
- **소셜 로그인 정보 연동 강화**: 카카오 로그인 시 사용자의 닉네임과 프로필 사진이 누락 없이 `profiles` 테이블에 저장되도록 로직을 개선했습니다.
- **임직원 전용 메뉴 접근성 개선**: 방문객도 인트라넷의 메뉴 구성을 확인할 수 있도록 보안 정책을 완화하되, 실제 데이터 접근은 페이지 레벨에서 제어하도록 변경했습니다.
- **지점 운영 리스트 정예화**: 요청에 따라 서울본사, 아산, 중부, 당진, 예산 5개 핵심 지점으로 리스트를 정리하고 아산지점 페이지에 식단게임 섹션을 추가했습니다.

### 🛠️ 작업 상세
#### 1. UI/UX 개선
- `app/layout.js`: `shortcut` 및 `apple` 아이콘 경로 추가 및 메타데이터 보강.
- `components/Header.js`: 
    - 방문자(`visitor`)에게도 '임직원전용' 메뉴가 보이도록 필터링 로직 제거 및 모바일 메뉴 복구.
    - 지점 드롭다운 메뉴를 5개 핵심 지점(서울, 아산, 중부, 당진, 예산)으로 정리.
- `app/employees/page.js`: 임직원 포털 메인 페이지의 지점 리스트를 5개 핵심 지점으로 정예화.
- `app/employees/branches/[branch]/page.js`: 아산지점(`asan`) 접근 시 하단에 '식단게임' 섹션 구성.
 - `app/employees/(intranet)/archive/loading.js` & `reports/loading.js`: 자료실 및 보고서 로딩 시 사용자 경험 개선을 위한 로딩 UI 추가.
 - **빌드 오류 수정**: `loading.js`에서 `styled-jsx` 사용으로 인한 서버 컴포넌트 제약 문제를 `'use client'` 지시어 추가로 해결했습니다.

#### 2. 인증 및 보안
- `app/auth/callback/route.js`: 카카오 메타데이터(`nickName`, `profile_image`) 매핑 로직 추가로 프로필 이미지 연동 해결.
- `middleware.js`: `/employees` 하위 경로(마이페이지 제외)에 대한 방문자 접근 허용으로 메뉴 가시성 확보.

#### 3. 데이터 및 성능
- `constants/locations.js`: 네트워크 지도 및 리스트에서 불필요한 지점을 제거하고 5개 핵심 거점 위주로 재편.
- 로딩 속도 개선을 위한 스켈레톤 UI 도입 가이드 수립.

---

## [2026-01-24] - 보안 강화, 버그 수정 및 기능 개선

### 🚀 핵심 성과
- **치명적 보안 결함 해결**: '방문객(visitor)' 권한의 사용자가 임직원 전용 페이지에 접근할 수 있었던 심각한 보안 문제를 `middleware.js`를 수정하여 완벽하게 해결했습니다.
- **사용자 정보 연동 오류 수정**: 신규 가입 시 `user_roles` 정보가 생성되지 않아 '내 정보 수정'이 실패하던 버그를 수정했습니다. 또한, `profiles` 테이블의 데이터가 올바르게 채워지지 않아 프로필 사진과 이름이 누락되던 문제를 데이터베이스 함수(RPC)를 도입하여 근본적으로 해결했습니다.
- **기능 개선**: 새로운 권한 변경 정책을 적용하고, 헤더에 '임직원 홈' 메뉴를 추가하여 사용성을 개선했습니다.

### 🛠️ 작업 상세
#### 1. 보안 강화
- **서버사이드 접근 제어 (`middleware.js`)**: 미들웨어에서 사용자의 `role`을 직접 조회하여, 'visitor'일 경우 `/employees` 또는 `/admin` 경로 접근 시 로그인 페이지로 리디렉션하도록 로직을 추가했습니다. 또한 'admin'이 아닌 사용자의 `/admin` 경로 접근도 차단했습니다.

#### 2. 핵심 버그 수정
- **인증 콜백 로직 수정 (`app/auth/callback/route.js`)**:
    - `profiles` 테이블 `UPSERT` 로직을, `id`가 `NULL`로 입력되던 오류를 해결하기 위해 안정적인 데이터베이스 함수(`upsert_profile`) 호출로 변경했습니다. 이로써 신규 사용자의 이름과 프로필 사진이 정상적으로 저장됩니다.
    - 로그인 성공 시, `user_roles` 테이블에 `id`와 `role: 'visitor'` 기본값을 `UPSERT` 하도록 수정하여 신규 사용자의 권한 정보 누락 문제를 해결했습니다.
- **데이터베이스 함수 추가**: `upsert_profile` RPC 함수를 생성하여 `profiles` 테이블의 `INSERT`와 `UPDATE` 로직을 원자적으로 안전하게 처리하도록 개선했습니다.

#### 3. 기능 개선 및 정책 변경
- **권한 변경 정책 구현**:
    - `api/users/me/route.js` (백엔드): 'visitor'는 권한 변경을 시도할 수 없도록 막고, 그 외 직원은 관리자 승인 없이 소속 지점(role)을 즉시 변경할 수 있도록 `PATCH` 로직을 수정했습니다.
    - `app/employees/mypage/page.js` (프론트엔드): 'visitor'에게는 권한 변경 드롭다운을 비활성화하고 안내 메시지를 표시하도록 UI를 수정했습니다.
- **'임직원 홈' 메뉴 추가 (`components/Header.js`)**: `navLinks` 설정에 '임직원 홈'(`/employees`)으로 연결되는 링크를 추가하여 내비게이션 편의성을 높였습니다.

---

## [2026-01-24] - 계정 연동 시스템 구축 및 UI/UX 개선

### 🚀 핵심 성과
- **계정 연동 시스템 구축**: 여러 소셜 계정(구글, 카카오 등)을 사용하더라도, 동일 이메일 기반으로 하나의 사용자로 인식되는 '계정 연동' 시스템을 완성했습니다. 이를 위해 `public.profiles` 테이블을 신설하고, 인증 및 주요 컴포넌트의 데이터 로직을 전면 리팩토링했습니다.
- **전역 프로필 훅(`useUserProfile`) 개발**: 통합된 사용자 정보(프로필, 역할 등)를 앱 전체에서 일관되게 가져올 수 있는 `useUserProfile` 훅을 개발하여 코드 중복을 제거하고 유지보수성을 향상시켰습니다.
- **UI/UX 개선**: 로그인 페이지의 버튼 정렬을 수정하고, 헤더에 소셜 프로필 이미지가 표시되도록 하여 사용 편의성과 시각적 완성도를 높였습니다.

### 🛠️ 작업 상세
#### 1. 계정 연동 아키텍처 설계 및 구현
- **DB 스키마 변경 (`supabase_account_linking.sql`)**: `email`을 고유 키로 사용하는 `public.profiles` 테이블을 신설하고, `phone` 열을 추가하는 DDL을 실행했습니다.
- **인증 콜백 로직 수정 (`app/auth/callback/route.js`)**: 로그인 성공 시, 사용자의 `email`을 기준으로 `profiles` 테이블에 프로필 정보를 `UPSERT` 하도록 수정하여 계정 정보를 통합했습니다.
- **'내 정보' API 리팩토링 (`api/users/me/route.js`)**: `GET`, `PATCH`, `DELETE` 요청 모두 `profiles` 테이블과 `user_roles` 테이블을 함께 사용하도록 수정하여, 통합 프로필과 역할을 분리하여 관리하도록 변경했습니다.
- **`useUserProfile` 훅 신설 (`hooks/useUserProfile.js`)**: 클라이언트 사이드에서 `auth.user`, `profiles`, `user_roles` 정보를 한번에 가져오는 전역 훅을 구현했습니다.
- **주요 컴포넌트 리팩토링**: `Header.js`, `EmployeeSidebar.js`, `contact/page.js` 등 사용자 정보가 필요한 모든 컴포넌트가 `useUserProfile` 훅을 사용하도록 수정하여 데이터 흐름을 중앙화하고 코드를 간소화했습니다.

#### 2. UI/UX 개선 작업
- **네이버 로그인 보류 조치**: 현재 네이버 측 설정 문제로 연동이 불가하여, `app/login/page.js`에서 관련 버튼을 임시로 제거했습니다.
- **로그인 버튼 정렬**: `app/login/login.module.css`의 버튼 스타일에 `line-height: 1`을 추가하여 아이콘과 텍스트의 수직 정렬을 수정했습니다.
- **프로필 이미지 표시**: `Header.js`와 `EmployeeSidebar.js`에서 `useUserProfile` 훅을 통해 `avatar_url`을 가져와 헤더와 사이드바에 사용자의 프로필 이미지를 표시하도록 개선했습니다.

#### 3. 정책 및 가이드라인 업데이트
- **`AGENT_GUIDELINES.md` 업데이트**: '계정 연동 정책'을 10번 항목으로 신설하여, 향후 모든 관련 작업의 기준으로 삼도록 명문화했습니다.

---

## [2026-01-24] - UI/UX 개선 및 네이버 로그인 보류 조치

### 🚀 핵심 성과
- **네이버 로그인 UI 제거**: 네이버 OIDC(OpenID Connect) 구현의 지속적인 설정 문제 및 `id_token` 미반환 문제로 인해, 현재는 로그인 페이지에서 네이버 로그인 버튼을 UI에서 제거했습니다. 이는 추후 재구현을 위해 보류된 상태입니다.
- **로그인 버튼 정렬 개선**: 로그인 페이지의 소셜 로그인 버튼(구글, 카카오)의 아이콘과 텍스트 수직 정렬 문제를 해결하여 디자인 완성도를 높였습니다.
- **사용자 프로필 이미지 표시**: 로그인한 사용자의 프로필 사진(아바타)을 Supabase 사용자 메타데이터(`avatar_url`)에서 가져와 헤더의 사용자 메뉴 영역에 표시하도록 구현했습니다. 프로필 이미지가 없을 경우 기존처럼 이니셜을 표시합니다.

### 🛠️ 작업 상세
#### 1. 네이버 로그인 버튼 제거 (`web/app/login/page.js`)
- `app/login/page.js` 파일에서 `네이버로 계속하기` 버튼 관련 JSX 코드를 제거했습니다.
- `app/login/page.js` 및 `app/auth/callback/route.js`에 구현되었던 네이버 관련 로직은 코드베이스에 유지하되, UI에서 비활성화된 상태입니다.

#### 2. 로그인 버튼 CSS 정렬 수정 (`web/app/login/login.module.css`)
- `.googleBtn` 및 `.kakaoBtn` CSS 클래스에 `line-height: 1;` 속성을 추가하여, 아이콘과 텍스트의 수직 정렬 불균형 문제를 해결했습니다.

#### 3. 사용자 프로필 이미지 표시 기능 구현 (`web/components/Header.js`)
- `components/Header.js` 파일에서 로그인한 사용자의 `user.user_metadata.avatar_url`을 확인하여, 해당 URL이 존재할 경우 프로필 이미지를 렌더링하도록 수정했습니다.
- 프로필 이미지가 없을 경우 기존의 이니셜 표시 로직(`displayInitial`)을 따르도록 폴백(fallback) 처리했습니다.
- 프로필 이미지(`<img>` 태그)에는 기존 이니셜 `<span>` 태그와 동일한 원형, 크기, 테두리, 그림자 스타일을 적용하여 디자인 일관성을 유지했습니다.

### 📋 참고 사항 및 향후 과제
- **네이버 로그인 재구현**: 네이버 OIDC 연동에 대한 추가적인 자료 조사 및 네이버 개발자 센터 설정 가이드 확인 후, 필요시 네이버 로그인을 재구현할 예정입니다.

---

## [2026-01-24] - 커스텀 네이버 소셜 로그인 최종 완성 (OIDC, signInWithIdToken)

### 🚀 핵심 성과
- **원클릭 네이버 로그인 구현**: 이메일 인증이 필요했던 이전의 OTP 방식을 폐기하고, OIDC(OpenID Connect) 표준의 `id_token`을 사용하는 방식으로 전환하여 클릭 한 번에 로그인이 완료되는 완벽한 사용자 경험을 구현했습니다.
- **`signInWithIdToken` 적용 성공**: Supabase의 `signInWithIdToken` 메서드를 성공적으로 적용하여, 커스텀 프로바이더(네이버)의 인증 정보를 통해 Supabase 세션을 즉시 발급받는 데 성공했습니다.

### 🛠️ 작업 상세
#### 1. 로그인 페이지 OIDC 요청 수정 (`web/app/login/page.js`)
- **`scope` 및 `nonce` 추가**: 네이버에 인증 요청 시 `scope` 파라미터에 'openid'를 추가하여 `id_token` 발급을 요청하고, 재전송 공격(Replay Attack) 방지를 위해 `nonce` 값을 생성하여 함께 전송하도록 수정했습니다.

#### 2. 인증 콜백 로직 OIDC 방식으로 전면 교체 (`web/app/auth/callback/route.js`)
- **`signInWithIdToken` 플로우 적용**:
    1.  네이버로부터 `code`를 받아 `id_token`과 `access_token`으로 교환합니다.
    2.  발급된 `id_token`을 디코딩하여, 요청 시 보냈던 `nonce` 값과 일치하는지 검증합니다.
    3.  검증 완료 후, `supabase.auth.signInWithIdToken` 함수에 `provider: 'openid'`와 함께 `id_token`, `nonce`를 전달하여 Supabase 인증 및 세션 생성을 완료합니다.
    4.  로그인 성공 후 사용자를 원래 목적지(`next` 파라미터)로 즉시 리디렉션합니다.

### 📋 참고 사항 및 최종 정정
- **로그 최종 정정**: 오늘 기록된 네이버 관련 로그 중, "공식 지원 확인" 및 "OTP 방식 구현" 내용은 모두 폐기하고, 이 **OIDC 방식 로그**를 최종본으로 삼습니다. Supabase에 지원되지 않는 소셜 로그인은 이 방식(Custom OIDC)으로 구현하는 것이 가장 올바른 방법임을 최종 확인했습니다.

---

## [2026-01-24] - 네이버 소셜 로그인 인증 정보 설정 및 연동 완료

### 🚀 핵심 성과
- **네이버 OAuth 연동 확정**: 발급된 네이버 Client ID와 Secret Key를 환경 변수에 반영하고, Supabase 프로바이더 설정을 위한 준비를 마쳤습니다.

### 🛠️ 작업 상세
#### 1. 환경 변수 구성 (`.env.local`)
- `NEXT_PUBLIC_NAVER_CLIENT_ID` 및 `NAVER_CLIENT_SECRET` 등록 완료.

---

## [2026-01-24] - 네이버 소셜 로그인 연동 준비 및 지원 여부 확인

### 🚀 핵심 확인 사항
- **네이버 프로바이더 지원 확인**: Supabase에서 네이버(Naver) OAuth를 공식 지원함을 확인하고, 대시보드 내 설정 위치를 파악했습니다.

### 🛠️ 향후 작업 계획
#### 1. 네이버 개발자 센터 설정
- 네이버 개발자 센터에서 Client ID 및 Secret 발급 후 Supabase에 등록 예정.

---

## [2026-01-24] - 카카오 소셜 로그인 연동 최종 성공

### 🚀 핵심 성과
- **카카오 OAuth 연동 완료**: 여러 차례의 설정 시행착오 끝에 카카오 로그인을 성공적으로 구현했습니다.

### 🛠️ 작업 상세
#### 1. 카카오 콘솔 설정 경로 최종 확인
- **Redirect URI 위치 교정**: `[내 애플리케이션 > 앱 키 > REST API 키]` 관련 설정 페이지 중간에 위치한 Redirect URI 등록 섹션을 확인하여 Supabase 콜백 주소(`.../auth/v1/callback`)를 정상 등록함.
- **동의 항목 최적화**: 이메일 권한 획득을 위한 본인 인증 절차 및 선택 동의 설정을 완료하여 `KOE205` 에러를 해결함.

---

## [2026-01-24] - 트러블슈팅: 카카오 Redirect URI 불일치(KOE006) 해결

### 🚀 핵심 이슈
- **KOE006 에러 발생**: 카카오 로그인 시 요청한 Redirect URI가 카카오 앱 설정에 등록된 URI와 일치하지 않아 인증이 거부됨. (JavaScript SDK 도메인 설정과 혼동됨)

### 🛠️ 해결 방안
#### 1. Redirect URI 경로 교정
- `[제품 설정 > 카카오 로그인]` 메뉴에서 Supabase 콜백 주소(`.../auth/v1/callback`)를 정확히 등록하도록 가이드함. 기존 플랫폼 도메인 설정과 분리하여 관리하도록 조치.

---

## [2026-01-24] - 트러블슈팅: 카카오 이메일 권한(KOE205) 정밀 진단 및 조치

### 🚀 핵심 이슈
- **권한 불일치 확인**: 카카오 앱 설정에서 `account_email`이 '권한 없음' 상태임에도 불구하고, Supabase 인증 모듈이 해당 정보를 요청하여 `KOE205` 에러 발생.

### 🛠️ 해결 방안
#### 1. 카카오 비즈니스 본인 인증 안내
- 개인 개발자 계정의 경우, [비즈니스 > 개인 개발자 비즈니스 정보]에서 본인 인증을 완료해야 이메일 항목을 '선택 동의'로 설정 가능함을 확인.
- 인증 후 동의 항목 설정을 '선택 동의'로 변경하도록 가이드라인 수립.

---

## [2026-01-24] - 카카오 이메일 권한 정책 분석 및 대응

### 🚀 핵심 이슈
- **이메일 획득 조건 확인**: 카카오 REST API 문서 분석 결과, 이메일 '필수 동의'를 위해서는 비즈니스 앱 등록이 필수임을 확인.

### 🛠️ 대응 방안
#### 1. 개인 개발자 환경 최적화
- 비즈니스 앱 전환 전까지 '카카오계정(이메일)'을 **선택 동의**로 설정하여 `KOE205` 에러를 방지함.
- Supabase 인증 시스템이 이메일 미제공 시에도 유연하게 대응할 수 있도록 설정 점검 권고.

---

## [2026-01-24] - 트러블슈팅: 카카오 OAuth 동의 항목(KOE205) 오류 해결

### 🚀 핵심 이슈
- **KOE205 에러 발생**: 카카오 로그인 시 `account_email` 동의 항목이 설정되지 않아 인가 코드 요청이 거부되는 현상 확인.

### 🛠️ 해결 방안
#### 1. 카카오 동의 항목 최적화
- 카카오 개발자 센터 내 `[카카오 로그인 > 동의항목]`에서 '카카오계정(이메일)'을 '선택 동의' 이상으로 설정하도록 가이드함. Supabase 인증 시스템의 이메일 기반 사용자 식별을 위해 필수적인 조치임.

---

## [2026-01-24] - 트러블슈팅: OAuth Provider 활성화 오류 대응

### 🚀 핵심 이슈
- **Unsupported provider 에러**: 카카오/네이버 로그인 시도 시 Supabase에서 `provider is not enabled` 에러 반환 확인.

### 🛠️ 해결 방안
#### 1. Supabase 인증 설정 가이드
- Supabase Dashboard 내 `Authentication > Providers` 메뉴에서 Kakao 및 Naver의 활성화(Enabled) 상태를 점검하고, 발급된 Client ID/Secret을 등록하도록 안내함.

---

## [2026-01-24] - 카카오 로그인 설정 경로 확인 및 업데이트

### 🚀 핵심 성과
- **설정 경로 최적화**: 사용자 피드백을 바탕으로 카카오 개발자 센터 내 `[플랫폼 > Web]` 섹션의 JavaScript 키 설정 항목에서 Redirect URI를 등록하는 경로를 확인하고 기록했습니다.

### 🛠️ 작업 상세
#### 1. 카카오 콘솔 설정 정보 갱신
- **Redirect URI 등록**: 형이 확인한 `[플랫폼 > Web]` 내 JavaScript 키 관련 설정 구역에 `https://bzbowsvfsyerhpgrdrva.supabase.co/auth/v1/callback` 등록 진행.
- **활성화 체크**: 로그인이 정상 작동하려면 `[제품 설정 > 카카오 로그인]` 메뉴의 활성화 스위치가 ON이어야 함을 명시.

---

## [2026-01-24] - 카카오 로그인 인증 정보 및 동의 항목 설정

### 🚀 핵심 성과
- **카카오 OAuth 연동 최적화**: 발급된 REST API 키와 시크릿 키를 환경 변수에 반영하고, 서비스 운영에 필요한 사용자 동의 항목 설정을 확정했습니다.

### 🛠️ 작업 상세
#### 1. 환경 변수 구성 (`.env.local`)
- `NEXT_PUBLIC_KAKAO_REST_API_KEY` 및 `KAKAO_CLIENT_SECRET` 등록.
#### 2. 사용자 동의 정책 수립
- **필수**: 닉네임 (실사용자 식별 및 이름 표시)
- **선택**: 프로필 사진 (인터넷/마이페이지 썸네일 활용)
- **이용 중 동의**: 카카오톡 메시지 전송 (향후 업무 알림 및 공지 발송용)

---

## [2026-01-24] - 소셜 로그인 확장: 카카오 및 네이버 연동

### 🚀 핵심 성과
- **인증 편의성 강화**: 기존 구글 로그인 외에 국내 사용 비중이 높은 카카오톡 및 네이버 로그인 기능을 추가하여 접근성을 개선했습니다.

### 🛠️ 작업 상세
#### 1. 로그인 페이지 업데이트 (`web/app/login/page.js`)
- 카카오 로그인 제한 로직(Alert) 제거 및 실제 OAuth 연동 활성화.
- 네이버 로그인 버튼 신설 및 `handleLogin('naver')` 연결.
- **카카오 설정 가이드**: Redirect URI 등록 및 OpenID Connect 활성화 권고 (웹훅은 추후 과제로 분류).
- **설정 유의사항**: 로그인용 Redirect URI(`.../callback`)와 로그아웃용 URI를 분리하여 안내.

---

## [2026-01-24] - 모바일 구글 OAuth 보안 정책 대응 완료

### 🚀 핵심 이슈
- **구글 로그인 차단 해결**: 네이버앱, 카카오톡 등 인앱 브라우저에서 구글 로그인 시 발생하는 '보안 브라우저 정책 위반' 에러 대응.

### 🛠️ 대응 방안
#### 1. 인앱 브라우저 감지 및 UI 안내 (`web/app/login/page.js`)
- `navigator.userAgent`를 분석하여 네이버, 카카오 등 주요 인앱 브라우저 환경을 감지하는 로직 추가.
- 인앱 브라우저 감지 시, 로그인 카드 내부에 "다른 브라우저로 열기"를 유도하는 경고 배너를 노출하여 사용자 이탈 방지.

---

## [2026-01-24] - 가이드라인 정교화: 구조화 및 일관성 원칙 강화

### 🚀 핵심 성과
- **설계 원칙 명문화**: 다양한 AI 툴(Cursor, Antigravity 등) 사용 시 발생할 수 있는 코드 스타일 파편화를 방지하기 위해 '일관성(Consistency)' 유지 원칙을 가이드라인에 명시했습니다.

### 🛠️ 작업 상세
#### 1. 가이드라인 업데이트 (`.agent/AGENT_GUIDELINES.md`)
- 6번 항목을 '프로젝트 구조화 및 일관성'으로 확장하여, 환경 변화에도 기존 설계 의도를 고수하도록 지침을 강화했습니다.

---

## [2026-01-24] - 환경 동기화 정책 구체화 및 .gitignore 최적화

### 🚀 핵심 성과
- **멀티 툴 협업 기반 강화**: Antigravity, Cursor, VSCode 등 다양한 개발 도구 사용 시 발생할 수 있는 설정 파일 충돌을 방지하기 위해 `.gitignore` 최적화안을 수립하고 가이드라인에 반영했습니다.

### 🛠️ 작업 상세
#### 1. 가이드라인 업데이트 (`.agent/AGENT_GUIDELINES.md`)
- 9번 항목 '멀티 툴 및 환경 동기화'에 `.gitignore` 관리 및 환경 변수 보안 지침을 추가하여 실행력을 높였습니다.

---

## [2026-01-23] - S3(MinIO) 연결 성공 및 UI/UX 대규모 개선

### 🚀 핵심 성과
- **S3(MinIO) 연결 완전 정복**: ISP 포트 차단(9000번 대) 문제를 HTTPS 역방향 프록시(443)와 WebSocket 헤더 설정을 통해 해결.
- **관리자 권한 관리 모바일화**: 테이블 형태의 레이아웃을 카드 슬롯(Card View) 방식으로 전면 개편하여 모바일 조작 편의성 극대화.
- **UI/UX 폴리싱**: 전사 메인 레이아웃 패딩 최적화, 헤더 유격 수정, 푸터 사이즈 축소 등 프리미엄 디자인 완성.

### 🛠️ 작업 상세
#### 1. 인프라 및 API
- `.env.local`: `NAS_ENDPOINT`를 HTTPS 프록시 주소로 설정.
- `lib/s3.js`: S3 클라이언트 설정 최적화 및 `getFileBufferFromS3` 추가로 이미지 서빙 안정화.
- `app/api/s3/files/route.js`: POST(업로드), GET(프록시 다운로드) 로직 구현.

#### 2. 프론트엔드 개선
- `app/admin/users/page.js`: 모바일용 카드 뷰 추가 및 반응형 레이아웃 적용. (Intranet 공통 모듈 연동)
- `app/employees/webzine/page.js`: S3 이미지 로딩 버그 수정 및 썸네일 경로 로직 최적화.
- `webzine/[id]/page.js`: 상세보기에서 Cloud 이미지 경로 인식하도록 수정.

#### 3. 기타 수정
- 소위원회 및 회사소개 페이지 서브메뉴 유격(20px) 제거.
- 푸터 높이 및 여백 축소.

### ⚠️ 주의사항 및 향후 과제
- **시놀로지 설정 유지**: 역방향 프록시에서 `X-Forwarded-Proto` 헤더와 `192.168.0.4` 대상 세팅이 바뀌면 S3 업로드가 바로 막힐 수 있음.
- **Webzine 이미지**: 이제 `Webzine/`으로 시작하는 모든 경로는 S3 Proxy API를 거쳐야 함.

---

## [2026-01-23] - 오픈 준비: 사용자 활동 로그(Audit Log) 시스템 구축

### 🚀 핵심 성과
- **전사 로그 시스템 도입**: 모든 사용자의 행위(이동, 클릭, 다운로드)를 실시간으로 기록하여 보안 및 운영 도구 확보.
- **3년 보관 정책 수립**: 서비스 오픈 가이드에 따라 로그 데이터를 최소 3년 동안 보관하도록 설계.

### 🛠️ 작업 상세
#### 1. 데이터베이스 (`web/supabase_user_logs.sql`)
- `user_activity_logs` 테이블 생성: `user_id`, `action_type`, `path`, `metadata`, `created_at` 등 포함.
- **보안**: RLS 설정을 통해 일반 사용자는 자기 로그만 생성 가능하고, 조지는 오직 `Admin` 권한자만 가능하도록 격리.

#### 2. 로깅 모듈 (`utils/logger.js`, `utils/loggerServer.js`)
- 클라이언트와 서버 양측에서 로그를 남길 수 있는 통합 유틸리티 구현.

#### 3. 자동 추적 (`components/ActivityLogger.js`)
- `RootLayout`에 탑재되어 페이지 뷰(URL) 및 중요 클릭 이벤트를 비동기로 자동 기록.

#### 4. 파일 접근 로깅 (`api/nas/preview`, `api/s3/files`)
- NAS 및 S3 파일 다운로드/조회 시 서버 레벨에서 정확한 파일명과 함께 로그 생성.

#### 5. 성능 최적화 (S3 Proxy Speed Up)
- **비차단형 로깅**: 로그 기록이 파일 전송을 방해하지 않도록 Background 처리를 적용하여 Latency 최소화.
- **강력한 브라우저 캐싱**: `Cache-Control: immutable` 설정을 통해 중복 요청 시 서버를 거치지 않고 즉시 로딩되도록 개선.
- **Buffer 전송 최적화**: 대용량 파일도 안정적으로 전달하기 위해 서버 메모리 핸들링 보강.

### 📋 운영 가이드 (보관 및 삭제)
- **보관 기한**: 3년 (2026~2029)
- **삭제 방법**: Supabase SQL Editor를 통해 `INTERVAL '3 years'` 기준 삭제 쿼리 권장.

## [2026-01-23] - 게시판 UI/UX 고도화 및 개발 정책 수립

###  핵심 성과
- **인트라넷 디자인 통일성 확보**: 자유게시판, 업무보고, 웹진 등 모든 사내 게시판에 프리미엄 화이트 카드(detailCard) 레이아웃을 적용하여 가독성과 심미성을 극대화.
- **편집 환경(Editor) 대규모 개선**: 구식 폼 디자인을 걷어내고 현대적인 UI로 개편, Hero 배너 및 사이드바 통합 레이아웃 시스템 안착.
- **NEW 개발 정책 도입**: 모바일 체크 필수화, UI/UX 일관성 유지, 수정 부위 TDD 의무화 등 고품질 협업을 위한 가이드라인(AGENT_GUIDELINES.md) 업데이트.

###  작업 상세
#### 1. 게시판 UI/UX (Free Board, Reports, Webzine)
- oard.module.css: 프리미엄 에디터 및 상세 카드 스타일(editorCard, detailCard) 추가.
- intranet/board/free/page.js: 목록 페이지 레이아웃 통합 및 카드 디자인 적용.
- intranet/board/free/[id]/page.js & /edit/page.js: 상세 보기 및 수정 페이지 레이아웃 고도화.
- intranet/reports/page.js & 
eports/[id]/page.js: 업무보고 시스템의 통일된 레이아웃 및 스타일 적용.
- webzine/page.js: 목록 썸네일 폴백(Fallback) 로직 강화 및 경로 인식 버그 수정.
- webzine/[id]/page.js & detail.module.css: 상세 페이지를 화이트 카드 스타일로 전면 개편.

#### 2. 인프라 및 기타 로직
- pp/api/s3/files/route.js: multipart/form-data 처리 시 ormData 객체 초기화 누락 버그 수정.
- AGENT_GUIDELINES.md: 형이 요청한 신규 개발 정책(모바일 점검, UI/UX 유지, TDD) 공식 추가.

###  신규 추가 정책 (준수 사항)
1. **모바일 우선 점검**: 모든 수정 사항은 반드시 모바일 페이지 뷰에서의 레이아웃을 확인한다.
2. **톤앤매너 유지**: 기존 UI/UX의 정체성을 훼손하지 않고 조화롭게 기능을 추가/수정한다.
3. **TDD 의무화**: 수동 점검 및 테스트 스크립트를 통해 수정된 로직의 무결성을 반드시 검증한다.

---

## [2026-01-23] - 개발 정책 고도화: 환경별 UI '분리' 및 '구조화' 정책 수립

###  핵심 성과
- **환경별 UI/UX 최적화 정책 도입**: 데스크탑과 모바일의 톤앤매너를 각각 독립적으로 유지하며, 디바이스 환경에 최적화된 사용자 경험을 제공하는 
분리 개발 원칙 수립.
- **프로젝트 구조화(Structuralization) 의무화**: 모든 폴더와 파일의 체계적인 관리를 위해 정해진 디렉토리 규칙을 엄격히 준수하고 중복을 지양하는 구조화 정책 도입.
- **가이드라인 공식 업데이트**: .agent/AGENT_GUIDELINES.md에 해당 내용을 추가하여 향후 모든 개발의 근간으로 삼음.

###  상세 정책 내역
1. **데스크탑 vs 모바일 분리**: 단순 반응형을 넘어, 각 환경에 어울리는 독립된 디자인과 조작 방식을 적용한다. (상호 기능은 연결되되 UI는 해당 환경에 최적화)
2. **엄격한 구조화**: 파일 시스템을 직관적이고 체계적으로 관리하며, 특히 인트라넷 관련 기능은 (intranet) 그룹 내로 질서 있게 배치한다.

---

## [2026-01-24] - 인트라넷 UI 정밀 최적화 및 편의 기능 고도화

### 🚀 핵심 성과
- **전화번호 자동 하이픈 기능 도입**: 사용자와 관리자 입력창 모두에서 숫자만 입력하면 휴대폰/유선전화 형식에 맞춰 자동으로 하이픈(-)이 생성되는 기능을 구현했습니다. (마이페이지, 관리자, 문의하기 등)
- **인트라넷 내비게이션(Middle Bar) 완벽 매칭**: '회사소개' 페이지의 미들바와 동일한 레이아웃, 모바일 동작(중앙 정렬 및 스크롤), 헤더 고정 위치(Sticky Top)를 적용하여 시각적 일관성을 확보했습니다.
- **권한 관리 시스템 안정화**: 일부 회원 정보가 누락되어 권한 변경이 실패하던 문제를 `UPSERT` 로직 도입으로 근본적으로 해결했습니다.

### 🛠️ 작업 상세
#### 1. 입력 편의성 개선
- `web/utils/format.js`: 한국 전화번호 형식(서울 02, 휴대폰 010, 지역번호 등)을 모두 지원하는 정교한 포매팅 로직 개발.
- 적용 페이지: `MyPage.js`, `AdminUsersPage.js`, `ContactPage.js`, `NewReportPage.js`.

#### 2. 내비게이션 및 레이아웃 정교화
- `IntranetSubNav.js` & `module.css`: 
    - 상단 헤더 높이(`--header-height`)에 맞춰 정확히 스티키 위치 조정.
    - `z-index`를 900으로 상향하여 콘텐츠와 겹치지 않게 수정.
    - 데스크탑 로그아웃 버튼에 세련된 아이콘 추가 및 미적 완성도 향상.
    - 모바일 메인 메뉴와 동일한 중단점(768px) 및 센터링 로직 적용.

#### 3. 관리자 권한 변경 버그 수정
- `web/app/api/admin/users/route.js`: 사용자 상세 정보(`user_roles`)가 없는 유저의 정보를 수정할 때도 자동으로 레코드를 생성하며 저장되도록 `update`를 `upsert`로 교체하여 "변경 실패" 오류를 해결했습니다.

### 📋 참고 사항
- **전화번호 입력**: 이제 01012345678 입력 시 010-1234-5678로 자동 변환됩니다. 백스페이스로 지울 때도 자연스럽게 동작합니다.
- **메뉴 정렬**: 모바일에서 인트라넷 메뉴가 회사소개 메뉴와 동일한 크기와 간격으로 깔끔하게 정렬됩니다.

---

## [2026-01-24] - 자료실 보안 정밀화 및 인트라넷 안정화

### 🚀 핵심 성과
- **자료실(NAS) 지점별 보안 정책 완성**: 지점별 독립 폴더, 보안 폴더(`_보안`) 격리, 권한별 가시성 제어 로직을 서버 레벨에서 완벽하게 구현했습니다.
- **웹 삭제 제한 및 오프라인 안내**: 데이터 유실 방지를 위해 웹에서의 무분별한 삭제를 막고, 사무실 PC 사용을 권장하는 전용 안내 시스템을 도입했습니다.
- **인트라넷 사용성 대규모 개선**: 로그인 전후 리다이렉트, 지점별 인트라넷 접근 오류, 모바일 게시판 가독성 등 현장에서 발생한 불편 사항을 전수 수정했습니다.

### 🛠️ 작업 상세
#### 1. 자료실(NAS) 보안 및 운영
- `app/api/nas/files/route.js`: 
    - 지점 매핑 및 보안 폴더(`_보안`) 노출 로직 구현.
    - **2중 보안**: 지점 일치 + 관리자 부여 '보안 권한' 체크 시에만 폴더 노출.
    - **어드민 특권**: 모든 숨김 파일, 시스템 파일, 타 지점 보안 폴더 전체 가시성 부여.
    - **삭제 잠금**: 관리자 외 삭제 시도 시 전용 모달(`ArchiveBrowser.js`) 노출 및 API 차단.
- `app/api/nas/files/permissions/route.js`: 프론트엔드 UI 제어를 위한 권한 플래그 연동.

#### 2. 인트라넷 내비게이션 및 로직 수정
- **지점 인트라넷 오류 수정**: Next.js 파라미터 로딩 버그를 수정하여 모든 지점(아산, 중부 등) 메뉴 접근 안정화.
- **로그인 리다이렉트 고도화**: `document.referrer` 분석을 통해 로그인 후 원래 보고 있던 페이지로 정확히 복귀.
- **누락 지점 일괄 등록**: 아산CY, 서산, 연천, 울산, 임고, 벌크사업부 등 전 지점을 헤더 및 포털에 추가.

#### 3. UI/UX 정밀 폴리싱 (TDD 검증 완료)
- **자유게시판 모바일 최적화**: 제목 폰트 확대(1.15rem), 메타 정보 축소(0.78rem)로 가독성 밸런스 조정.
- **문의하기 모바일 레이아웃**: 카드 슬롯 가변 폭 적용 및 가로 스크롤(Overflow) 현상 해결.
- **테스트 자동화**: `test_latest_fixes.js`를 통해 핵심 로직(useState, Redirect, CSS) 사전 검증 프로세스 구축.

### ⚠️ 주의사항
- **보안 폴더 명칭**: 반드시 `[지점명]_보안` 형식을 유지해야 시스템이 인식합니다. (하이픈 아님)
- **권한 관리**: 이제 관리자 페이지의 **🔐(보안)** 체크박스가 NAS 보안 폴더 접근의 핵심 스위치입니다.

---