# Development Log

## [2026-01-23] - S3(MinIO) 연결 성공 및 UI/UX 대규모 개선

### 🚀 핵심 성과
- **S3(MinIO) 연결 완전 정복**: ISP 포트 차단(9000번 대) 문제를 HTTPS 역방향 프록시(443)와 WebSocket 헤더 설정을 통해 해결.
- **관리자 권한 관리 모바일화**: 테이블 형태의 레이아웃을 카드 슬롯(Card View) 방식으로 전면 개편하여 모바일 조작 편의성 극대화.
- **UI/UX 폴리싱**: 전사 메인 레이아웃 패딩 최적화, 헤더 유격 수정, 푸터 사이즈 축소 등 프리미엄 디자인 완성.

### 🛠️ 작업 상세
#### 1. 인프라 및 API
- `.env.local`: `NAS_ENDPOINT`를 HTTPS 프록시 주소로 설정.
- `lib/s3.js`: S3 클라이언트 설정 최적화 및 `getFileBufferFromS3` 추가로 이미지 서빙 안정화.
- `app/api/s3/files/route.js`: POST(업로드), GET(프록시 다운로드) 로직 구현.

#### 2. 프론트엔드 개선
- `app/admin/users/page.js`: 모바일용 카드 뷰 추가 및 반응형 레이아웃 적용. (Intranet 공통 모듈 연동)
- `app/employees/webzine/page.js`: S3 이미지 로딩 버그 수정 및 썸네일 경로 로직 최적화.
- `webzine/[id]/page.js`: 상세보기에서 Cloud 이미지 경로 인식하도록 수정.

#### 3. 기타 수정
- 소위원회 및 회사소개 페이지 서브메뉴 유격(20px) 제거.
- 푸터 높이 및 여백 축소.

### ⚠️ 주의사항 및 향후 과제
- **시놀로지 설정 유지**: 역방향 프록시에서 `X-Forwarded-Proto` 헤더와 `192.168.0.4` 대상 세팅이 바뀌면 S3 업로드가 바로 막힐 수 있음.
- **Webzine 이미지**: 이제 `Webzine/`으로 시작하는 모든 경로는 S3 Proxy API를 거쳐야 함.

---

## [2026-01-23] - 오픈 준비: 사용자 활동 로그(Audit Log) 시스템 구축

### 🚀 핵심 성과
- **전사 로그 시스템 도입**: 모든 사용자의 행위(이동, 클릭, 다운로드)를 실시간으로 기록하여 보안 및 운영 도구 확보.
- **3년 보관 정책 수립**: 서비스 오픈 가이드에 따라 로그 데이터를 최소 3년 동안 보관하도록 설계.

### 🛠️ 작업 상세
#### 1. 데이터베이스 (`web/supabase_user_logs.sql`)
- `user_activity_logs` 테이블 생성: `user_id`, `action_type`, `path`, `metadata`, `created_at` 등 포함.
- **보안**: RLS 설정을 통해 일반 사용자는 자기 로그만 생성 가능하고, 조지는 오직 `Admin` 권한자만 가능하도록 격리.

#### 2. 로깅 모듈 (`utils/logger.js`, `utils/loggerServer.js`)
- 클라이언트와 서버 양측에서 로그를 남길 수 있는 통합 유틸리티 구현.

#### 3. 자동 추적 (`components/ActivityLogger.js`)
- `RootLayout`에 탑재되어 페이지 뷰(URL) 및 중요 클릭 이벤트를 비동기로 자동 기록.

#### 4. 파일 접근 로깅 (`api/nas/preview`, `api/s3/files`)
- NAS 및 S3 파일 다운로드/조회 시 서버 레벨에서 정확한 파일명과 함께 로그 생성.

#### 5. 성능 최적화 (S3 Proxy Speed Up)
- **비차단형 로깅**: 로그 기록이 파일 전송을 방해하지 않도록 Background 처리를 적용하여 Latency 최소화.
- **강력한 브라우저 캐싱**: `Cache-Control: immutable` 설정을 통해 중복 요청 시 서버를 거치지 않고 즉시 로딩되도록 개선.
- **Buffer 전송 최적화**: 대용량 파일도 안정적으로 전달하기 위해 서버 메모리 핸들링 보강.

### 📋 운영 가이드 (보관 및 삭제)
- **보관 기한**: 3년 (2026~2029)
- **삭제 방법**: Supabase SQL Editor를 통해 `INTERVAL '3 years'` 기준 삭제 쿼리 권장.

## [2026-01-23] - 게시판 UI/UX 고도화 및 개발 정책 수립

###  핵심 성과
- **인트라넷 디자인 통일성 확보**: 자유게시판, 업무보고, 웹진 등 모든 사내 게시판에 프리미엄 화이트 카드(detailCard) 레이아웃을 적용하여 가독성과 심미성을 극대화.
- **편집 환경(Editor) 대규모 개선**: 구식 폼 디자인을 걷어내고 현대적인 UI로 개편, Hero 배너 및 사이드바 통합 레이아웃 시스템 안착.
- **NEW 개발 정책 도입**: 모바일 체크 필수화, UI/UX 일관성 유지, 수정 부위 TDD 의무화 등 고품질 협업을 위한 가이드라인(AGENT_GUIDELINES.md) 업데이트.

###  작업 상세
#### 1. 게시판 UI/UX (Free Board, Reports, Webzine)
- oard.module.css: 프리미엄 에디터 및 상세 카드 스타일(editorCard, detailCard) 추가.
- intranet/board/free/page.js: 목록 페이지 레이아웃 통합 및 카드 디자인 적용.
- intranet/board/free/[id]/page.js & /edit/page.js: 상세 보기 및 수정 페이지 레이아웃 고도화.
- intranet/reports/page.js & 
eports/[id]/page.js: 업무보고 시스템의 통일된 레이아웃 및 스타일 적용.
- webzine/page.js: 목록 썸네일 폴백(Fallback) 로직 강화 및 경로 인식 버그 수정.
- webzine/[id]/page.js & detail.module.css: 상세 페이지를 화이트 카드 스타일로 전면 개편.

#### 2. 인프라 및 기타 로직
- pp/api/s3/files/route.js: multipart/form-data 처리 시 ormData 객체 초기화 누락 버그 수정.
- AGENT_GUIDELINES.md: 형이 요청한 신규 개발 정책(모바일 점검, UI/UX 유지, TDD) 공식 추가.

###  신규 추가 정책 (준수 사항)
1. **모바일 우선 점검**: 모든 수정 사항은 반드시 모바일 페이지 뷰에서의 레이아웃을 확인한다.
2. **톤앤매너 유지**: 기존 UI/UX의 정체성을 훼손하지 않고 조화롭게 기능을 추가/수정한다.
3. **TDD 의무화**: 수동 점검 및 테스트 스크립트를 통해 수정된 로직의 무결성을 반드시 검증한다.

---

## [2026-01-23] - 개발 정책 고도화: 환경별 UI '분리' 및 '구조화' 정책 수립

###  핵심 성과
- **환경별 UI/UX 최적화 정책 도입**: 데스크탑과 모바일의 톤앤매너를 각각 독립적으로 유지하며, 디바이스 환경에 최적화된 사용자 경험을 제공하는 
분리 개발 원칙 수립.
- **프로젝트 구조화(Structuralization) 의무화**: 모든 폴더와 파일의 체계적인 관리를 위해 정해진 디렉토리 규칙을 엄격히 준수하고 중복을 지양하는 구조화 정책 도입.
- **가이드라인 공식 업데이트**: .agent/AGENT_GUIDELINES.md에 해당 내용을 추가하여 향후 모든 개발의 근간으로 삼음.

###  상세 정책 내역
1. **데스크탑 vs 모바일 분리**: 단순 반응형을 넘어, 각 환경에 어울리는 독립된 디자인과 조작 방식을 적용한다. (상호 기능은 연결되되 UI는 해당 환경에 최적화)
2. **엄격한 구조화**: 파일 시스템을 직관적이고 체계적으로 관리하며, 특히 인트라넷 관련 기능은 (intranet) 그룹 내로 질서 있게 배치한다.

---

## [2026-01-24] - 인트라넷 UI 정밀 최적화 및 편의 기능 고도화

### 🚀 핵심 성과
- **전화번호 자동 하이픈 기능 도입**: 사용자와 관리자 입력창 모두에서 숫자만 입력하면 휴대폰/유선전화 형식에 맞춰 자동으로 하이픈(-)이 생성되는 기능을 구현했습니다. (마이페이지, 관리자, 문의하기 등)
- **인트라넷 내비게이션(Middle Bar) 완벽 매칭**: '회사소개' 페이지의 미들바와 동일한 레이아웃, 모바일 동작(중앙 정렬 및 스크롤), 헤더 고정 위치(Sticky Top)를 적용하여 시각적 일관성을 확보했습니다.
- **권한 관리 시스템 안정화**: 일부 회원 정보가 누락되어 권한 변경이 실패하던 문제를 `UPSERT` 로직 도입으로 근본적으로 해결했습니다.

### 🛠️ 작업 상세
#### 1. 입력 편의성 개선
- `web/utils/format.js`: 한국 전화번호 형식(서울 02, 휴대폰 010, 지역번호 등)을 모두 지원하는 정교한 포매팅 로직 개발.
- 적용 페이지: `MyPage.js`, `AdminUsersPage.js`, `ContactPage.js`, `NewReportPage.js`.

#### 2. 내비게이션 및 레이아웃 정교화
- `IntranetSubNav.js` & `module.css`: 
    - 상단 헤더 높이(`--header-height`)에 맞춰 정확히 스티키 위치 조정.
    - `z-index`를 900으로 상향하여 콘텐츠와 겹치지 않게 수정.
    - 데스크탑 로그아웃 버튼에 세련된 아이콘 추가 및 미적 완성도 향상.
    - 모바일 메인 메뉴와 동일한 중단점(768px) 및 센터링 로직 적용.

#### 3. 관리자 권한 변경 버그 수정
- `web/app/api/admin/users/route.js`: 사용자 상세 정보(`user_roles`)가 없는 유저의 정보를 수정할 때도 자동으로 레코드를 생성하며 저장되도록 `update`를 `upsert`로 교체하여 "변경 실패" 오류를 해결했습니다.

### 📋 참고 사항
- **전화번호 입력**: 이제 01012345678 입력 시 010-1234-5678로 자동 변환됩니다. 백스페이스로 지울 때도 자연스럽게 동작합니다.
- **메뉴 정렬**: 모바일에서 인트라넷 메뉴가 회사소개 메뉴와 동일한 크기와 간격으로 깔끔하게 정렬됩니다.

---

## [2026-01-24] - 자료실 보안 정밀화 및 인트라넷 안정화

### 🚀 핵심 성과
- **자료실(NAS) 지점별 보안 정책 완성**: 지점별 독립 폴더, 보안 폴더(`_보안`) 격리, 권한별 가시성 제어 로직을 서버 레벨에서 완벽하게 구현했습니다.
- **웹 삭제 제한 및 오프라인 안내**: 데이터 유실 방지를 위해 웹에서의 무분별한 삭제를 막고, 사무실 PC 사용을 권장하는 전용 안내 시스템을 도입했습니다.
- **인트라넷 사용성 대규모 개선**: 로그인 전후 리다이렉트, 지점별 인트라넷 접근 오류, 모바일 게시판 가독성 등 현장에서 발생한 불편 사항을 전수 수정했습니다.

### 🛠️ 작업 상세
#### 1. 자료실(NAS) 보안 및 운영
- `app/api/nas/files/route.js`: 
    - 지점 매핑 및 보안 폴더(`_보안`) 노출 로직 구현.
    - **2중 보안**: 지점 일치 + 관리자 부여 '보안 권한' 체크 시에만 폴더 노출.
    - **어드민 특권**: 모든 숨김 파일, 시스템 파일, 타 지점 보안 폴더 전체 가시성 부여.
    - **삭제 잠금**: 관리자 외 삭제 시도 시 전용 모달(`ArchiveBrowser.js`) 노출 및 API 차단.
- `app/api/nas/files/permissions/route.js`: 프론트엔드 UI 제어를 위한 권한 플래그 연동.

#### 2. 인트라넷 내비게이션 및 로직 수정
- **지점 인트라넷 오류 수정**: Next.js 파라미터 로딩 버그를 수정하여 모든 지점(아산, 중부 등) 메뉴 접근 안정화.
- **로그인 리다이렉트 고도화**: `document.referrer` 분석을 통해 로그인 후 원래 보고 있던 페이지로 정확히 복귀.
- **누락 지점 일괄 등록**: 아산CY, 서산, 연천, 울산, 임고, 벌크사업부 등 전 지점을 헤더 및 포털에 추가.

#### 3. UI/UX 정밀 폴리싱 (TDD 검증 완료)
- **자유게시판 모바일 최적화**: 제목 폰트 확대(1.15rem), 메타 정보 축소(0.78rem)로 가독성 밸런스 조정.
- **문의하기 모바일 레이아웃**: 카드 슬롯 가변 폭 적용 및 가로 스크롤(Overflow) 현상 해결.
- **테스트 자동화**: `test_latest_fixes.js`를 통해 핵심 로직(useState, Redirect, CSS) 사전 검증 프로세스 구축.

### ⚠️ 주의사항
- **보안 폴더 명칭**: 반드시 `[지점명]_보안` 형식을 유지해야 시스템이 인식합니다. (하이픈 아님)
- **권한 관리**: 이제 관리자 페이지의 **🔐(보안)** 체크박스가 NAS 보안 폴더 접근의 핵심 스위치입니다.

---
